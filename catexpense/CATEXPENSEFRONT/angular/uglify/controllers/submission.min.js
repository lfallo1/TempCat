"use strict";angular.module("expenseApp.Controllers").controller("SubmissionCtrl",["$scope","$modal","$window","$location","$route","$rootScope","$timeout","LineItemService","SubmissionService","RepliconProjectService","MessageService","DateService","Application","Authentication","ReceiptService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){void 0!==m.getSubmission()&&(a.missingLineItems=m.getSubmission().LineItems.length<1)}function q(){j.getAllRepliconProjects().then(function(b){b.data.length>0?(m.setRepliconProjects(b.data),a.clients=b.data,a.selectedClient=a.clients[0],a.clientManager=a.selectedClient.RepliconManagerName+"@catalystitservices.com",a.loading=!1,a.hasNoProjects=!1):a.hasNoProjects=!0},function(a){console.log(a)})}function r(a){var b={sunday:{},monday:{},tuesday:{},wednesday:{},thursday:{},friday:{},saturday:{}},c=a.split(",");c.forEach(function(a){var c=a.split(":");switch(c[0]){case"Miles":h.setMiles(c[1]);case"Origin":h.setOrigin(c[1]);case"Destination":h.setDestination(c[1]);case"EndingWeek":h.setEndingWeek(new Date(c[1]));case"Sunday":b.sunday="true"===c[1];case"Monday":b.monday="true"===c[1];case"Tuesday":b.tuesday="true"===c[1];case"Wednesday":b.wednesday="true"===c[1];case"Thursday":b.thursday="true"===c[1];case"Friday":b.friday="true"===c[1];case"Saturday":b.saturday="true"===c[1]}}),h.setDays(b)}a.syncComplete=!1,a.flag=!1,a.hasNoProjects=!1,a.clients=[{RepliconProjectName:"Loading..."}],a.loading=!0,a.lineItems=[],a.disabled=!0,a.submission=m.getSubmission(),a.submissionLoad=void 0===m.getSubmission(),a.submissionUnderEdit=h.getUnderEdit(),a.submissionCreated=!1,a.currentDescription="",a.editExistingSubmission=!1,a.receiptsAmount=0;var s,t;m.getSubmission()&&(a.submittedNotApproved=2===m.getSubmissionStatus()&&m.getSubmission().ActiveDirectoryUser.toUpperCase()==n.getUserName().toUpperCase(),a.createNewItemLoad=1==a.submission.StatusId||4==a.submission.StatusId||6==a.submission.StatusId),a.dt1="",a.submissionExists=!1,a.se=function(){return a.submissionExists},a.editComment=function(a){f.$broadcast("editCommentFromSubmission",a)},p(),a.findSpecificSubmission=function(){var b=!1;return a.totalSubmissions.forEach(function(c,d){var e=new Date(c.WeekEndingDate),f=new Date(e.toUTCString().substring(0,16)),g=new Date(a.dt1.toUTCString().substring(0,16));f.valueOf()===g.valueOf()&&c.RepliconProjectId===a.selectedClient.RepliconProjectId&&(b=c,m.setSubmissionIndex(d))}),b},a.clientAndDate=function(){return null!==a.selectedClient&&a.dt1 instanceof Date&&!isNaN(a.dt1.valueOf())?(a.submission=a.findSpecificSubmission(),a.createNewItemLoad=!1,t!==a.dt1&&a.afClient!==a.selectedClient&&f.$broadcast("submissionFound",a.submission),m.setAllUserSubmissions(a.totalSubmissions),a.submission?(a.missingLineItems=a.submission.LineItems.length<1,a.submissionExists=!0,a.createNewItemLoad=1==a.submission.StatusId||4==a.submission.StatusId||6==a.submission.StatusId):(a.currentDescription="",a.submissionExists=!1),s=a.selectedClient,t=a.dt1,!0):!1},a.getSubmissionList=function(){void 0!=m.getAllUserSubmissions()?a.totalSubmissions=m.getAllUserSubmissions():i.getSubmissionsByUsername().then(function(b){for(var c=b.data,d=0;d<c.length;d++){for(var e=[],f=0;f<c[d].LineItems.length;f++)if(0!=c[d].LineItems[f].Receipts.length)for(var g=0;g<c[d].LineItems[f].Receipts.length;g++)e.push(c[d].LineItems[f].Receipts[g]);c[d].allSubmissionReceipts=e,c[d].ReceiptPresent=e.length>0?!0:!1}a.totalSubmissions=c,m.setAllUserSubmissions(c)},function(a){console.log(a)})},a.getSubmissionList(),void 0!=m.getRepliconProjects()?(a.clients=m.getRepliconProjects(),a.selectedClient=a.clients[0],a.clientManager=a.selectedClient.RepliconManagerName+"@catalystitservices.com",a.loading=!1):q(),a.$on("syncComplete",function(){a.syncComplete=!0,q()}),a.createNewSubmission=function(){a.disableCreate=!0;var b={statusId:1,RepliconProjectId:a.selectedClient.RepliconProjectId,WeekEndingDate:a.dt1,ManagerName:a.selectedClient.RepliconManagerName,Description:a.currentDescription};i.submitExpenseReport(b).then(function(b){if(a.submissionCreated=!0,a.submissionId=b.data.SubmissionId,a.submission=b.data,a.getSubmissionList(),h.resetLineItem(),h.setUnderEdit(!1),h.setSubmissionId(b.data.SubmissionId),h.setExpenseCategoryName("Mileage"),h.setEndingWeek(a.dt1),void 0!=m.getAllUserSubmissions())var c=m.getAllUserSubmissions();else var c=a.totalSubmissions;a.submission.RepliconProject=a.selectedClient,a.submission.Status={StatusName:"In Progress"},a.submission.allSubmissionReceipts=[],a.submission.ReceiptPresent=!1,c.push(a.submission),m.setAllUserSubmissions(c),f.$broadcast("addSubmissionEmployeeTable"),a.openModal()},function(a){console.log(a)})},a.deleteSubmission=function(){k.setMessage("Are you sure you want to delete this submission?"),k.setBroadCastMessage("confirmDeleteSubmissionUnderEdit"),k.setId(a.submission.SubmissionId);b.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController",resolve:{selectedType:function(){return a.selectedType}}})},a.$on("confirmDeleteSubmissionUnderEdit",function(){k.setMessage(""),k.setBroadCastMessage(""),i.deleteExpenseReport(k.getId()).then(function(){c.location.href="/"},function(){})}),a.addNewLineItem=function(){h.resetLineItem(),h.setUnderEdit(!1);var b=a.dt1;a.submission||(a.submission=m.getSubmission(),h.setSubmissionId(a.submission.SubmissionId)),b||(b=new Date(a.submission.WeekEndingDate)),h.setSubmissionId(a.submission.SubmissionId),h.setExpenseCategoryName("Mileage"),h.setEndingWeek(b),a.openModal()},a.editExpenseLine=function(b,c){m.setLineItemIndex(c),h.resetLineItem(),r(b.LineItemMetadata),h.setSubmissionId(b.SubmissionId),h.setLineItemId(b.LineItemId),h.setExpenseCategoryName(b.ExpenseCategory.ExpenseCategoryName),h.setLineItemDate(new Date(b.LineItemDate)),h.setLineItemDesc(b.LineItemDesc),h.setLineItemAmount(b.LineItemAmount),h.setBillable(b.Billable),h.setEndingWeek(a.dt1),h.setUnderEdit(!0),a.openModal()},a.openDetailsView=function(){},a.showAllReceipts=function(){o.setReceipts(o.getAllReceipts()),o.setShowAllReceipts(!0),o.setAddReceipt(!1);b.open({templateUrl:"Views/HotTowel/views/modals/receiptModal.html",controller:"receiptController"})},a.$on("checkReceipts",function(){if(o.getAllReceipts()&&0!=o.getAllReceipts().length)a.receipts=!1;else{for(var b=[],c=0;c<a.submission.LineItems.length;c++)if(0!=a.submission.LineItems[c].Receipts.length)for(var d=0;d<a.submission.LineItems[c].Receipts.length;d++)b.push(a.submission.LineItems[c].Receipts[d]);o.setAllReceipts(b),a.receipts=0!=b.length?!1:!0}a.receiptsAmount=o.getAllReceipts().length}),a.getManager=function(){a.clientManager=a.selectedClient.RepliconManagerName+"@catalystitservices.com"},a.openModal=function(){var c=b.open({templateUrl:"Views/HotTowel/views/modals/formDetailsView.html",controller:"FormDetailsCtrl"});c.result.then(function(c){1==h.getUnderEdit()?(h.updateLineItem(c.LineItemId,c).then(function(b){if(void 0!=m.getAllUserSubmissions())var c=m.getAllUserSubmissions();else var c=a.totalSubmissions;c[m.getSubmissionIndex()].LineItems[m.getLineItemIndex()]=b.data;for(var d=0,e=0;e<c[m.getSubmissionIndex()].LineItems.length;e++)d+=c[m.getSubmissionIndex()].LineItems[e].LineItemAmount;c[m.getSubmissionIndex()].TotalAmount=d,h.resetLineItem()},function(a){console.log(a)}),h.setUnderEdit(!1)):c.forEach(function(c){h.submitLineItem(c).then(function(c){if(void 0!=m.getAllUserSubmissions())var d=m.getAllUserSubmissions();else var d=a.totalSubmissions;a.disableCreate=!1,c.data.ExpenseCategory={ExpenseCategoryName:h.getExpenseCategoryNameById(c.data.ExpenseCategoryId)},d[m.getSubmissionIndex()].LineItems.push(c.data);for(var e=0,f=0;f<d[m.getSubmissionIndex()].LineItems.length;f++)e+=d[m.getSubmissionIndex()].LineItems[f].LineItemAmount;if(d[m.getSubmissionIndex()].TotalAmount=e,a.showComments=!0,h.setLineItemId(c.data.LineItemId),m.setLineItemIndex(d[m.getSubmissionIndex()].LineItems.length-1),o.getAddReceipt()){o.setReceipts(d[m.getSubmissionIndex()].LineItems[m.getLineItemIndex()].Receipts);{b.open({templateUrl:"Views/HotTowel/views/modals/receiptModal.html",controller:"receiptController"})}}else{k.setMessage("Would you like to add a receipt for this line item?"),k.setBroadCastMessage("addReeciptForLineItem");{b.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController"})}}a.$on("addReeciptForLineItem",function(){o.setAddReceipt(!0),o.setReceipts(d[m.getSubmissionIndex()].LineItems[m.getLineItemIndex()].Receipts);b.open({templateUrl:"Views/HotTowel/views/modals/receiptModal.html",controller:"receiptController"})})},function(a){console.log(a)})})},function(b){a.disableCreate=!1,console.log(b)})},a.submitTable=function(){if(a.submission.LineItems.length>0)a.submission.Status.StatusName="Submitted",a.submission.Status.StatusId=2,i.updateSubmission(a.submission.SubmissionId,a.submission).then(function(){var b=m.getAllUserSubmissions();b[m.getSubmissionIndex()]=a.submission,a.dt1="",a.currentDescription="",a.submissionCreated=!1,c.location.reload()},function(a){console.log(a)});else{k.setMessage("You can not submit a table without any expense items"),k.setBroadCastMessage("confirmNoEmptyLineItems"),k.setId(a.submission.SubmissionId);{b.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController",resolve:{selectedType:function(){return a.selectedType}}})}}},a.$on("confirmNoEmptyLineItems",function(){k.setMessage(""),k.setBroadCastMessage(""),e.reload()}),a.unSubmit=function(){a.submission.Status.StatusName="In Progress",a.submission.Status.StatusId=1,i.updateSubmission(a.submission.SubmissionId,a.submission).then(function(){var b=m.getAllUserSubmissions();b[m.getSubmissionIndex()]=a.submission,a.dt1="",a.currentDescription="",a.submissionCreated=!1,c.location.reload()},function(){})},a.saveTable=function(){a.submission.Description=a.currentDescription,a.submission.RepliconProjectId=a.selectedClient.RepliconProjectId,a.submission.WeekEndingDate=a.dt1,a.submission.Status.StatusName="In Progress",a.submission.Status.StatusId=1,i.updateSubmission(a.submission.SubmissionId,a.submission).then(function(){var b=m.getAllUserSubmissions();b[m.getSubmissionIndex()]=a.submission,a.dt1="",a.currentDescription="",a.submissionCreated=!1,c.location.reload()},function(){})},a.$watch("dt1",function(b){if(""!=b&&"string"!=typeof b)if(6===b.getDay())a.dt1=b;else{var c=6-b.getDay(),d=new Date;a.dt1=new Date(d.setDate(b.getDate()+c))}},!0)}]);