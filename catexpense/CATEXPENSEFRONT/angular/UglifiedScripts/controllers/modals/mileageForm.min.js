"use strict";angular.module("expenseApp.Controllers").controller("MileageCtrl",["$scope","LineItemService","MapQuestService","ValidationService",function(a,b,c,d){function e(){a.mileageValues={date:"",origin:"",destination:"",distance:0,description:"",amount:0,billable:!1,totalMiles:0},f()}function f(){a.mileageValidation={date:{valid:!0,message:"This field is valid."},origin:{valid:!0,message:"This field is valid."},destination:{valid:!0,message:"This field is valid."},miles:{valid:!0,message:"This field is valid."},description:{valid:!0,message:"This field is valid."},validInput:!0}}var g=0;a.calculatingDistance=!1,a.editingExistingMileage=b.getUnderEdit(),a.editingNewMileage=!1,a.mileageValidation={date:{valid:!0,message:"This field is valid."},origin:{valid:!0,message:"This field is valid."},destination:{valid:!0,message:"This field is valid."},miles:{valid:!0,message:"This field is valid."},description:{valid:!0,message:"This field is valid."},validInput:!0},a.mileageValues={date:b.getLineItemDate(),origin:b.getOrigin(),destination:b.getDestination(),miles:b.getMiles(),description:b.getLineItemDesc(),amount:b.getLineItemAmount(),billable:b.getBillable()},a.editMileage=function(b){g=b,a.mileageValues.date=a.mileageArray[g].date,a.mileageValues.origin=a.mileageArray[g].origin,a.mileageValues.destination=a.mileageArray[g].destination,a.mileageValues.miles=a.mileageArray[g].miles,a.mileageValues.description=a.mileageArray[g].description,a.mileageValues.amount=a.mileageArray[g].amount,a.mileageValues.billable=a.mileageArray[g].billable,a.editingNewMileage=!0},a.deleteMileage=function(b){a.editingNewMileage&&g===b&&e(),a.mileageArray.splice(b,1),a.mileageArray.length<=0&&(a.editingNewMileage=!1),g=0},a.getDistance=function(){a.calculatingDistance=!0;var b={from:a.mileageValues.origin,to:a.mileageValues.destination};c.getDistance(b).then(function(b){a.calculatingDistance=!1,0!==b.data.info.statuscode?(a.mileageValidation.miles.valid=!1,a.mileageValidation.miles.message=b.data.info.messages[0]):(a.mileageValues.miles=b.data.route.distance,a.mileageValidation.miles.valid=!0,a.mileageValidation.miles.message="This field is valid.")},function(b){console.log(b),a.calculatingDistance=!1})},a.getAmount=function(){a.mileageValues.amount=.4*a.mileageValues.miles},a.saveAsNewMileage=function(){var b="Miles:"+a.mileageValues.miles+",Origin:"+a.mileageValues.origin+",Destination:"+a.mileageValues.destination+",Sunday:false,Monday:false,Tuesday:false,Wednesday:false,Thursday:false,Friday:false,Saturday:false",f={LineItemDate:a.mileageValues.date,LineItemDesc:a.mileageValues.description,LineItemAmount:a.mileageValues.amount,LineItemMetadata:b},g={location:a.mileageValues.origin},h={location:a.mileageValues.destination};c.getLocation(g).then(function(b){c.getLocation(h).then(function(c){0===b.data.results[0].locations.length?(a.mileageValidation.origin.valid=!1,a.mileageValidation.origin.message="Invalid Origin."):(a.mileageValidation.origin.valid=!0,a.mileageValidation.origin.message="This field is valid."),0===c.data.results[0].locations.length?(a.mileageValidation.destination.valid=!1,a.mileageValidation.destination.message="Invalid Destination."):(a.mileageValidation.destination.valid=!0,a.mileageValidation.destination.message="This field is valid."),a.mileageValidation.origin.valid&&a.mileageValidation.destination.valid&&(a.mileageValidation=d.validateMileage(f),a.mileageValidation.validInput&&(a.mileageValues.valid=a.mileageValidation.validInput,a.mileageArray.push(a.mileageValues),e()))},function(a){console.log(a)})},function(a){console.log(a)})},a.saveChanges=function(){var b="Miles:"+a.mileageValues.miles+",Origin:"+a.mileageValues.origin+",Destination:"+a.mileageValues.destination+",Sunday:false,Monday:false,Tuesday:false,Wednesday:false,Thursday:false,Friday:false,Saturday:false",c={LineItemDate:a.mileageValues.date,LineItemDesc:a.mileageValues.description,LineItemAmount:a.mileageValues.amount,LineItemMetadata:b};a.mileageValidation=d.validateMileage(c),a.mileageValidation.validInput&&(a.mileageArray[g].date=a.mileageValues.date,a.mileageArray[g].origin=a.mileageValues.origin,a.mileageArray[g].destination=a.mileageValues.destination,a.mileageArray[g].distance=a.mileageValues.distance,a.mileageArray[g].description=a.mileageValues.description,a.mileageArray[g].amount=a.mileageValues.amount,a.mileageArray[g].billable=a.mileageValues.billable,e(),a.editingNewMileage=!1)},a.discardChanges=function(){resetValues(),a.editingNewMileage=!1},a.$watch("mileageValues",function(c,e){a.getAmount(),c!==e&&a.editingLineItem&&(b.setLineItemDate(a.mileageValues.date),b.setLineItemDesc(a.mileageValues.description),b.setOrigin(a.mileageValues.origin),b.setDestination(a.mileageValues.destination),b.setMiles(a.mileageValues.miles),b.setLineItemAmount(a.mileageValues.amount),b.setBillable(a.mileageValues.billable),a.mileageValidation=d.validateMileage(b.getLineItem()),a.mileageArray[0]=a.mileageValues,a.mileageArray[0].valid=a.mileageValidation.validInput)},!0),a.today=function(){a.otherValues.date=new Date},a.clear=function(){a.$scope.otherValues.date=null},a.toggleMin=function(){a.minDate=b.getDaysString().sunday},a.toggleMin(),a.toggleMax=function(){a.maxDate=b.getDaysString().saturday},a.toggleMax(),a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={formatYear:"yy",startingDay:1},a.formats=["yyyy/MM/dd","EEEE - MMM. dd/yyyy","dd.MM.yyyy","shortDate"],a.format=a.formats[1]}]);