"use strict";angular.module("expenseApp.Controllers").controller("submissionTableCtrl",["$scope","$route","$modal","$location","$rootScope","$filter","Application","ReceiptService","LineItemService","MessageService","CommentService","SubmissionService","Authentication",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.receipts=!0;var n=f("orderBy"),o={field:"DateCreated",reverse:!1};a.submissionOrder=function(b){b===o.field?(o.reverse=!o.reverse,a.currentSubmission.LineItems=n(a.currentSubmission.LineItems,o.field,o.reverse)):(o.field=b,o.reverse=!1,a.currentSubmission.LineItems=n(a.currentSubmission.LineItems,o.field,o.reverse))},a.$on("submissionFound",function(b,c){if(h.setAllReceipts([]),g.setOrigin("EmployeeTable"),a.userName=m.getUserName(),c&&(e.$broadcast("checkReceipts"),a.currentDescription=c.Description,a.createNewItemLoad=1==c.StatusId||4==c.StatusId||6==c.StatusId,a.currentSubmission=c,a.isApprover=!1,a.showComments=0!=c.LineItems.length,0!=a.currentSubmission.LineItems.length))for(var d=0;d<a.currentSubmission.Comments.length;d++)a.currentSubmission.Comments[d].commentIsMine=a.currentSubmission.Comments[d].RepliconUserName.toUpperCase()==a.userName.toUpperCase()?!0:!1}),a.$on("confirmDeleteLineItem",function(){j.setMessage(""),j.setBroadCastMessage(""),i.deleteLineItem(j.getId()).then(function(){a.currentSubmission.LineItems.splice(j.getIndex(),1),a.showComments=0!=a.currentSubmission.LineItems.length;for(var b=0,c=g.getAllUserSubmissions(),d=0;d<c[g.getSubmissionIndex()].LineItems.length;d++)b+=c[g.getSubmissionIndex()].LineItems[d].LineItemAmount;c[g.getSubmissionIndex()].TotalAmount=b,g.setSubmissionStatus(c)},function(a){console.log(a)})}),a.confirmLineRemove=function(a,b){j.setMessage("Are you sure you want to delete this line item? NOTE: Any attached receipts will be permanently delete."),j.setBroadCastMessage("confirmDeleteLineItem"),j.setId(a.LineItemId),j.setIndex(b);c.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController"})},a.isApprover=!1,a.createNewItemLoad=1==g.getSubmissionStatus()||4==g.getSubmissionStatus()||6==g.getSubmissionStatus();"EmployeeTable"!==g.getOrigin()&&(a.isApprover=m.getIsManager||m.getIsFinanceApprover?!0:!1),a.userName=m.getUserName();var p;if(a.$on("editCommentFromSubmission",function(b,d){-1!=d?(p=d,g.setComment(a.currentSubmission.Comments[d])):g.setComment("");c.open({templateUrl:"Views/HotTowel/views/modals/commentModal.html",controller:"CommentController"})}),a.editComment=function(b){if(-1!=b){if(g.setIsNewComment(!1),!a.currentSubmission.Comments[b].commentIsMine)return;p=b,g.setComment(a.currentSubmission.Comments[b]),g.setCommentIndex(b)}else g.setIsNewComment(!0),g.setComment("");c.open({templateUrl:"Views/HotTowel/views/modals/commentModal.html",controller:"CommentController"})},a.$on("addNewReceipt",function(b,c){var d=g.getAllUserSubmissions(),f=h.getAllReceipts();f.push(c),h.setAllReceipts(f),d[g.getSubmissionIndex()].allSubmissionReceipts=f,d[g.getSubmissionIndex()].ReceiptPresent=!0,d[g.getSubmissionIndex()].LineItems[g.getLineItemIndex()].ReceiptPresent=!0,d[g.getSubmissionIndex()].LineItems[g.getLineItemIndex()].Receipts.push(c),h.setReceipts(f),g.setAllUserSubmissions(d),a.currentSubmission=d[g.getSubmissionIndex()],e.$broadcast("addSubmissionEmployeeTable")}),g.getSubmission()){a.currentSubmission=g.getSubmission(),a.userName=m.getUserName(),a.showComments=0!=a.currentSubmission.LineItems.length,a.createNewItemLoad=1==a.currentSubmission.StatusId||4==a.currentSubmission.StatusId||6==a.currentSubmission.StatusId,a.dt1=a.currentSubmission.WeekEndingDate,a.currentDescription=a.currentSubmission.Description,(m.getIsFinanceApprover()||m.getIsManager())&&(a.isApprover=!0),e.$broadcast("checkReceipts");for(var q=0;q<g.getRepliconProjects().length;q++)a.currentSubmission.RepliconProject.RepliconProjectName==g.getRepliconProjects()[q].RepliconProjectName&&(a.selectedClient=g.getRepliconProjects()[q]);if(a.editExistingSubmission=!0,0!=a.currentSubmission.LineItems.length)for(var q=0;q<a.currentSubmission.Comments.length;q++)a.currentSubmission.Comments[q].commentIsMine=a.currentSubmission.Comments[q].RepliconUserName.toUpperCase()==a.userName.toUpperCase()?!0:!1}a.approve=function(){j.setAddComment(!1),j.setMessage("Please confirm you are about to approve this submission."),j.setBroadCastMessage("confirmApproveSubmission");c.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController"})},a.reject=function(){j.setMessage("Please confirm you are about to reject this submission."),j.setBroadCastMessage("confirmRejectSubmission"),j.setAddComment(!0);c.open({templateUrl:"Views/HotTowel/views/modals/confirmModal.html",controller:"confirmModalController"})},a.viewReceipts=function(b,d){g.setLineItemId(b),g.setLineItemIndex(d),h.setAddReceipt(!1),h.setShowAllReceipts(!1),h.setReceipts(a.currentSubmission.LineItems[d].Receipts);c.open({templateUrl:"Views/HotTowel/views/modals/receiptModal.html",controller:"receiptController"})},a.$on("refreshCreateNewItemLoad",function(){a.editExistingSubmission=!1}),a.$on("confirmApproveSubmission",function(){var b="";b=a.isApprover&&"ManagerTable"==g.getOrigin()?"Manager Approved":"Finance Approved",a.currentSubmission.Status.StatusName=b,l.updateSubmission(a.currentSubmission.SubmissionId,a.currentSubmission).then(function(){if("Manager Approved"==b){var a=g.getPendingSubmissionsByManagerName();a.splice(g.getSubmissionIndex(),1)}else{var a=g.getPendingSubmissionsByFinanceApprover();a.splice(g.getSubmissionIndex(),1)}g.setPendingSubmissionsByFinanceApprover(a),d.path("/home")})}),a.$on("confirmRejectSubmission",function(b,c){var e="";e=a.isApprover&&"ManagerTable"==g.getOrigin()?"Manager Rejected":"Finance Rejected",a.currentSubmission.Status.StatusName=e,a.currentSubmission.Comments=new Array,a.currentSubmission.Comments[0]={},a.currentSubmission.Comments[0].ExpenseComment=c,l.updateSubmission(a.currentSubmission.SubmissionId,a.currentSubmission).then(function(){if("Manager Rejected"==e){var a=g.getPendingSubmissionsByManagerName();a.splice(g.getSubmissionIndex(),1)}else{var a=g.getPendingSubmissionsByFinanceApprover();a.splice(g.getSubmissionIndex(),1)}d.path("/home")})}),a.$on("saveComment",function(b,c){g.getComment().ExpenseComment?k.PutComment(g.getComment().CommentId,c).then(function(){a.currentSubmission.Comments[p].ExpenseComment=c}):k.CreateComment(a.currentSubmission.SubmissionId,c).then(function(b){b.data.commentIsMine=!0,a.currentSubmission.Comments.push(b.data)})})}]);